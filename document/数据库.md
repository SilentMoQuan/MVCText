# 基本条件

1. 上千所学校
2. 成百上千万的教师和学生
3. 以 1 , 2 条为基础, 产生的关系
4. 查询如何优化



学生表

教师表

班级表

学校表

上课信息表

教室表

....



如果再添加一个教室表，和上课信息表，来存储上课地点和所上的课程信息，这个时候表又怎么设计？



-------



# ???



## 索引字段数 和 索引个数 之前的取舍



根据 查询语句 和 实际情况 对索引来进行设计



1、表的主键、外键必须有索引；
2、数据量超过300的表应该有索引；
3、经常与其他表进行连接的表，在连接字段上应该建立索引；
4、经常出现在Where子句中的字段，特别是大表的字段，应该建立索引；
5、索引应该建在选择性高的字段上；
6、索引应该建在小字段上，对于大的文本字段甚至超长字段，不要建索引；
7、复合索引的建立需要进行仔细分析；尽量考虑用单字段索引代替：

　　A、正确选择复合索引中的主列字段，一般是选择性较好的字段；

　　B、复合索引的几个字段是否经常同时以AND方式出现在Where子句中？单字段查询是否极少甚至没有？如果是，则可以建立复合索引；否则考虑单字段索引；

　　C、如果复合索引中包含的字段经常单独出现在Where子句中，则分解为多个单字段索引；

　　D、如果复合索引所包含的字段超过3个，那么仔细考虑其必要性，考虑减少复合的字段；

　　E、如果既有单字段索引，又有这几个字段上的复合索引，一般可以删除复合索引；
8、频繁进行数据操作的表，不要建立太多的索引；
9、删除无用的索引，避免对执行计划造成负面影响； 以上是一些普遍的建立索引时的判断依据。一言以蔽之，索引的建立必须慎重，对每个索引的必要性都应该经过仔细分析，要有建立的依据。因为太多的索引与不充分、不正确的索引对性能都毫无益处：在表上建立的每个索引都会增加存储开销，索引对于插入、删除、更新操作也会增加处理上的开销。另外，过多的复合索引，在有单字段索引的情况下，一般都是没有存在价值的；相反，还会降低数据增加删除时的性能，特别是对频繁更新的表来说，负面影响更大



## 实际开发过程中是否使用外键约束



1. 不使用数据库外键
2. 使用外键会发生一些未知的错误
3. 所有的外键约束都由程序进行保证



## 有些字段为纯数字, 使用varchar类型而不使用INT类型



1. varchar可以存储"0"开头的值, int不可以
2. varchar在长度方面更自由, int固定11
3. 性能差异较小, 尤其是在有索引的情况下





# CREATE TABLE



系统分配<br />000000 000 000<br />学校标识 班级标识 次序标识



## 主表

### student

| 列名              | 类型        | 约束                       | 描述                     |
| ----------------- | ----------- | -------------------------- | ------------------------ |
| id                | INT         | PRIMARY KEY AUTO_INCREMENT | 系统分配自增字段         |
| real_id           | VARCHAR(10) | NOT NULL DEFAULT ""        | 学生在学校中的学号       |
| name              | VARCHAR(20) | NOT NULL DEFAULT ""        | 学生姓名                 |
| grade_name        | VARCHAR(10) | NOT NULL DEFAULT ""        | 学生级名                 |
| class_name        | VARCHAR(10) | NOT NULL DEFAULT ""        | 学生班名                 |
| classroom_real_id | VARCHAR(10) | NOT NULL DEFAULT ""        | 学生上课教室号(学校内部) |
| school_name       | VARCHAR(30) | NOT NULL DEFAULT ""        | 学生所在学校名           |



### teacher

| 列名              | 类型        | 约束                       | 描述               |
| ----------------- | ----------- | -------------------------- | ------------------ |
| id                | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键       |
| real_id           | VARCHAR(10) | NOT NULL DEFAULT ""        | 教师在学校中的工号 |
| name              | VARCHAR(20) | NOT NULL DEFAULT ""        | 教师名             |
| teach_course_name | VARCHAR(30) |                            | 教授课程名         |
| school_name       | VARCHAR(30) | NOT NULL DEFAULT ""        | 学校名             |



### class_grade

| 列名              | 类型        | 约束                       | 描述             |
| ----------------- | ----------- | -------------------------- | ---------------- |
| id                | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键     |
| grade_name        | VARCHAR(10) | NOT NULL DEFAULT "",       | 级名             |
| class_name        | VARCHAR(10) | NOT NULL DEFAULT "",       | 班名             |
| classroom_real_id | VARCHAR(10) | NOT NULL DEFAULT "",       | 教室号(学校内部) |
| school_name       | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名           |



### school

| 列名 | 类型        | 约束                       | 描述         |
| ---- | ----------- | -------------------------- | ------------ |
| id   | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键 |
| name | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名       |



### classroom

| 列名        | 类型        | 约束                       | 描述             |
| ----------- | ----------- | -------------------------- | ---------------- |
| id          | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键     |
| real_id     | VARCHAR(10) | NOT NULL DEFAULT "",       | 教室号(学校内部) |
| grade_name  | VARCHAR(10) | NOT NULL DEFAULT "",       | 级名             |
| class_name  | VARCHAR(10) | NOT NULL DEFAULT "",       | 班名             |
| school_name | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名           |



### teach_course_info

| 列名              | 类型        | 约束                       | 描述             |
| ----------------- | ----------- | -------------------------- | ---------------- |
| id                | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键     |
| teacher_name      | VARCHAR(20) | NOT NULL DEFAULT ""        | 教师名           |
| classroom_real_id | VARCHAR(10) | NOT NULL DEFAULT "",       | 教室号(学校内部) |
| grade_name        | VARCHAR(10) | NOT NULL DEFAULT "",       | 级名             |
| class_name        | VARCHAR(10) | NOT NULL DEFAULT "",       | 班名             |
| course_name       | VARCHAR(30) |                            | 教授课程名       |
| school_name       | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名           |



## 维护表



### class_grade_teacher

| 列名           | 类型        | 约束                       | 描述                 |
| -------------- | ----------- | -------------------------- | -------------------- |
| id             | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键         |
| class_grade_id | INT         |                            | 班级号(系统分配主键) |
| teacher_id     | INT         |                            | 教师号(系统分配主键) |
| school_name    | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名               |



### student_teacher

| 列名        | 类型        | 约束                       | 描述                 |
| ----------- | ----------- | -------------------------- | -------------------- |
| id          | INT         | PRIMARY KEY AUTO_INCREMENT | 系统自增主键         |
| student_id  | INT         |                            | 学生号(系统分配主键) |
| teacher_id  | INT         |                            | 教师号(系统分配主键) |
| school_name | VARCHAR(30) | NOT NULL DEFAULT "",       | 学校名               |







# 数据库设计



## 0.4



### 主表



-  学生表
   - 冗余字段
     - 级名
     - 班名
     - 学校名
     - 教室号(学校内部)
   - 维护表 
     - 学生_教师表
   - 主键
     - 学号(系统分配)
   - 索引
     - 学校名+级名+班名+学号(学校内部)
     - 学校名+教室号(学校内部)+学号(学校内部)
   - 修改
     - 冗余字段
       - 班级名
         - 拆分为 级名 和 班名
         - 方便将学生的 等级进行升级, 查询后组合起来一样
     - 索引
       - 学校名+班级名+学号(学校内部)
         - 拆分 并添加为  学校名+级名+班名+学号(学校内部)
         - 字段更改 索引需要做相应修改

- 教师表
  - 冗余字段
    - 学校名
  - 维护表
    - 班级_教师 表
    - 学生_教师 表
  - 主键
    - 教师号(系统分配)
  - 索引
    - 学校名+教师号(学校内部)
    - 学校名+课程名+教师名
  - 修改
    - 索引
      - 新增 学校名+课程名+教师名
        - 方便进行筛选
        - 方便通过课程信息查询教师信息
        - 一个课程可以有很多老师教授
        - 一个老师在一个学期内教授一种课程



- 班级表
  - 冗余字段
    - 学校名
    - 教室号(学校内部)
  - 主键
    - 班级号(系统分配)
  - 索引
    - 学校名+级名+班名
    - 学校名+教室号(学校内部)
  - 修改
    - 冗余字段
      - 上课信息号(系统分配)
        - 删除
        - 上课信息号存储的是一条上课信息, 并不是一个班级的课程表
        - 即 xxx老师, 在xxx教师, 给xxx班, 上xxx课 为一条记录
        - 理解错误 删除
    - 索引
      - 学校名+班级名+上课信息号
        - 拆分为 学校名+级名+班名
        - 字段更改 索引需要做相应修改



- 学校表
  - 冗余字段
    - 无
  - 主键
    - 学校号(系统分配)
  - 索引
    - 学校名



- 教室表
  - 冗余字段
    - 级名
    - 班名
    - 学校名
  - 主键
    - 教室号(系统分配)
  - 索引
    - 学校名+教室号(学校内部)
    - 学校名+级名+班名
  - 修改
    - 冗余字段
      - 上课信息号(系统分配)
        - 删除
        - 上课信息号存储的是一条上课信息, 并不是一个班级的课程表
        - 即 xxx老师, 在xxx教室, 给xxx班, 上xxx课 为一条记录
        - 理解错误 删除
    - 索引
      - 学校名+班级名
        - 拆分为 学校名+级名+班名
        - 字段更改 索引需要做相应修改



- 上课信息表
  - 冗余字段
    - 学校名
    - 级名
    - 班名
    - 教室号(学校内部)
  - 主键
    - 上课信息号(系统分配)
  - 索引
    - 学校名+级名+班名+上课信息号
    - 学校名+教室号(学校内部)+上课信息号
    - 学校名+教师名
  - 修改
    - 冗余字段
      - 班级名
        - 拆分为 级名 和 班名
        - 方便将学生的 等级进行升级, 查询后组合起来一样
        - 将 班名 和 级名 分开可以进一步细化筛选
      - 教室号
        - 新增字段
        - xxx老师, 在xxx教室, 给xxx班, 上xxx课 
    - 索引
      - 学校名+班级名+上课信息号
        - 拆分为 学校名+级名+班名+上课信息号
        - 字段更改 索引需要做相应修改
      - 学校名+教师名
        - 新加索引
        - 查看这个老师的课程安排



### 关系表



- 班级_教师表
  - 冗余字段
    - 学校名
  - 主键
    - 自增主键
  - 索引
    - 学校名+班级号+教师号
      - 索引类型: 唯一索引
  - 修改 - 还未修改 - 展示思路
    - 冗余字段
      - 移除 学校名
      - 班级 教师 使用的是系统分配的 id 不会出现重复
    - 索引
      - 学校名+班级号+教师号
        - 类型: 唯一索引
        - 字段变化, 索引变化



- 学生_教师表
  - 冗余字段
    - 学校名
  - 主键
    - 自增主键
  - 索引
    - 学校名+学生号+教师号
    
      - 索引类型: 唯一索引
    
      - ```sql
        EXPLAIN SELECT * FROM student_teacher
        WHERE school_name = "青青草原第一小学" AND teacher_id = 3
        -- 没有索引
        -- 返回了 1 行
        -- 
        -- 执行耗时   : 0.045 sec
        -- 传送时间   : 0 sec
        -- 总耗时      : 0.046 sec
        
        -- 添加全字段索引
        -- 返回了 1 行
        -- 
        -- 执行耗时   : 0 sec
        -- 传送时间   : 0.002 sec
        -- 总耗时      : 0.003 sec
        ```



-------



## 0.3

-  学生表
  - 冗余字段
    - 班级名
    - 学校名
    - 教室号(学校内部)
  - 维护表 
    - 学生_教师表
  - 主键
    - 学号(系统分配)
  - 索引
    - 学校名+班级名+学号(学校内部)
    - 学校名+教室号(学校内部)+学号(学校内部)




- 教师表
  - 冗余字段
    - 学校名
  - 维护表
    - 班级_教师 表
    - 学生_教师 表
  - 主键
    - 教师号(系统分配)
  - 索引
    - 学校名+教师号(学校内部)



- 班级表
  - 冗余字段
    - 学校名
    - 教室号(学校内部)
    - 上课信息号(系统分配)
  - 主键
    - 班级号(系统分配)
  - 索引
    - 学校名+班级名
    - 学校名+教室号(学校内部)



- 学校表
  - 冗余字段
    - 无
  - 主键
    - 学校号(系统分配)
  - 索引
    - 学校名



- 教室表
  - 冗余字段
    - 班级名
    - 学校名
    - 上课信息号(系统分配)
  - 主键
    - 教室号(系统分配)
  - 索引
    - 学校名+教室号(学校内部)
    - 学校名+班级名



- 上课信息表
  - 冗余字段
    - 学校名
    - 班级名
  - 主键
    - 上课信息号(系统分配)
  - 索引
    - 学校名+班级名+上课信息号
    - 学校名+教室号(学校内部)+上课信息号



## 0.2

-  学生表
  - 冗余字段
    - 班级名
    - 学校名
    - 教室号(学校内部)
  - 维护表 
    - 学生_教师表
  - 主键
    - 学号(系统分配)
  - 索引
    - 学校名+班级名+学号(学校内部)
    - 学校名+教室号(学校内部)+学号(学校内部)



- 教师表
  - 冗余字段
    - 学校名
  - 维护表
    - 班级_教师 表
    - 学生_教师 表
  - 主键
    - 教师号(系统分配)
  - 索引
    - 学校名+教师号(学校内部)



- 班级表
  - 冗余字段
    - 学校名
    - 教室号(学校内部)
    - 上课信息号(系统分配)
  - 主键
    - 班级号(系统分配)
  - 索引
    - 学校名+班级名
    - 学校名+教室号(学校内部)



- 学校表
  - 冗余字段
    - 无
  - 主键
    - 学校号(系统分配)
  - 索引
    - 学校名



- 教室表
  - 冗余字段
    - 班级名
    - 学校名
    - 上课信息号(系统分配)
  - 主键
    - 教室号(系统分配)
  - 索引
    - 学校名+教室号(学校内部)
    - 学校名+班级名



- 上课信息表
  - 冗余字段
    - 学校名
    - 班级名
  - 主键
    - 上课信息号(系统分配)
  - 索引
    - 学校名+班级名+上课信息号
    - 学校名+教室号(学校内部)+上课信息号



### 分析

学生

一批学生有一个教师

一批学生有一个学校

一批学生有一个班级

一批学生有一个教室

一批学生有一个上课信息



老师

一个老师有一批学生

一个老师有一批教室

一批老师有一个学校

一个老师有一批上课信息

一个老师有一批班级



班级

教师教授一批学生

教师在不同教室教授不同学生

一批教师属于一个学校

教师同时存在于不同的上课信息中



班级

一个班级有一批学生

一个班级有一批老师

一批班级属于一个学校

一个班级使用一个教室

一个班级使用一个上课信息



学校

一个学校有一批学生

一个学校有一批老师

一个学校有一批班级

一个学校有一批上课信息

一个学校有一批教室



上课信息

一个上课信息有一批学生

一个上课信息有一批老师

一批上课信息有一个学校

一个上课信息有一个教室

一个上课信息有一个班级



教室表

一个教室有一批学生

一个教室有一批老师

一批教室有一个学校

一个教室有一个班级

一个教室有一个上课信息



|          | 学生 | 老师 | 班级 | 学校 | 教室 | 上课信息 |
| -------- | ---- | ---- | ---- | ---- | ---- | -------- |
| 学生     | 1    | n    | n    | n    | n    | n        |
| 老师     | n    | 1    | n    | n    | n    | n        |
| 班级     | 1    | n    | 1    | n    | 1    | 1        |
| 学校     | 1    | 1    | 1    | 1    | 1    | 1        |
| 教室     | 1    | n    | 1    | n    | 1    | 1        |
| 上课信息 | 1    | n    | 1    | n    | 1    | 1        |



- 学生表
  - 学生表查询更为频繁, 基数最大
  - 根据学生数量进行分表 1000w
  - 根据字段数量将冗余字段进行垂直分表
  - 冗余字段
    - 班级名
    - 学校名
    - 教室号
    - 上课信息号(id)
  - 维护表 
    - 学生_教师表
      - 学生基数 和 教师基数 是最大的 而且都是多对对关系 再考虑
  - 主键
    - 学号(系统分配)
  - 
- 教师表
  - 教师基数仅次于学生基数, 查询较为频繁
  - 冗余字段
    - 学校名
  - 维护表
    - 教师_班级表
      - 教师和班级也是多对多关系, 且 教师基数不低 使用维护表更为合适
  - 主键
    - 教师号(系统分配)
  - 索引
    - 学校名+学校内部教师号
- 班级表
  - 班级一般只在学期更替的时候出现改动, 基数较低, 查询频率与教师相近
  - 冗余字段
    - 学校名
    - 教室号
    - 上课信息号(可选)
  - 主键
    - 班级号(系统分配)
  - 索引
    - 学校名+班级号
    - 学校名+教室号
  - 补充
    - 教室
      - 由于班级的添加或减少
      - 所以能出现空的教室
      - 但是不能出现空的班级
      - 无法做成一对一关系
    - 上课信息
      - 一个班级必定有一个自己的课程表
      - 因此班级和课程表之间有着一对一关系
      - 所以可以将班级号作为上课信息系表的主键
      - 上课信息表作为垂直分表 减少每行的数据  提升查询速度
- 学校表
  - 数据基数最小, 改动幅度最小, 相对来说查询需求较大
  - 学校作为最顶级的单位, 尽量不出现其他冗余
  - 冗余字段
    - 无
  - 主键
    - 学校号(系统分配)
  - 索引
    - 学校名
      - 学校名是最基础的学校信息, 因此在众多表中都存在冗余列
      - 学校名的重复率极低
- 教室表
  - 基数多于班级, 删改的次数少于班级
  - 冗余字段
    - 班级号
    - 学校名
    - 上课信息号
  - 主键
    - 教室号(系统分配)
  - 索引
    - 学校名+学校内部教室号
      - 由于同一个学校中教室号不能一致
      - 教室删改次数较小
- 上课信息表
  - 每学期变动较大, 基数与班级相同
  - 冗余字段
    - 学校名
    - 班级号
    - 教室号
  - 主键
    - 上课信息号(系统分配 / 成为班级表的垂直分表 使用班级号)
  - 索引
    - 学校名+班级号+上课信息号
    - 学校名+教室号+上课信息号



## 0.1

条件



学生 

老师

班级

学校



通过 学生 查询 学校



学生 学生班级 班级

老师 老师班级 班级

学校 学校班级 班级





一 

- 学生表 
  - 包含 班级名

- 班级表 
  - 包含 校名 
  - 添加索引 班级名 
- 学校表
  - 添加索引 学校名 
- 教师表
  - 教师 和 班级 是 多对多关系
  - 建立 教师_班级表



二 

- 学生表
  - 包含 班级名
  - 包含 学校名
- 班级表
  - 包含 学校名
  - 添加索引 班级名
- 学校表
  - 添加索引 学校名
- 教师表
  - 建立 教师_班级表



学生表

老师表

班级表

教室表

上课信息表

学校表



学生查询教师信息

学生查询多种信息

.....

...查询...











  
